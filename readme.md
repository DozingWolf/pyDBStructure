# DB表结构提取工具

## 用途
对已建立的系统，根据数据库内已有的表信息，整理出表文档以及相关对象信息。

## 为什么要做
某年某月某日，某公司研发人员做了一套新系统。当我向研发人员索取表文档时，研发人员花了很长时间才提交出系统表文档。

问了下原因，一是前期设计全部是在数据库内边研发边设计的，没有整理成文的文档信息。二是收到命令后研发发现无法很便利的取出数据库内已经记录的设计信息，最后由研发人工整理后提交。

这实在过于愚蠢了。只能我自己上手了。放狗搜索后发现确实没有一个比较方便的根据数据库反向生成表结构的工具，遂决定自己写一个工具，便利未来研发、项目和运维使用。

设计这个工具要能够应对某公司业务使用的几种RDBMS，因研发的新系统是MSSQL，第一个适配就按照MSSQL进行开发。后续逐步适配Oracle和MySQL，考虑未来适配PG。先行提供这几个主流RDBMS的文档生成功能，其余数据库未来有接触到再行商议。

## 设计思路
通过查询语句获取表清单，根据表清单去逐一查询对应的表结构信息，并把关联到表的数据库对象一并查询出来。将结果集构造出一个数据结果集，发送至生成表格的模块，根据要求和规则写入excel成文文档。

## 研发环境

Python 3.10.5 64bit

Windows10 22H2

Oracle Client 12c 12.2.0.1.0

Microsoft ODBC Drive 18 for SQL Server (x64)

## 依赖
参见requirements.txt

## 怎么用
1. 根据requirements.txt文件安装依赖

    - pip install 根据requirements.txt批量安装，或者自行安装依赖包
    - MSSQL使用了pyodbc包，需要安装odbc驱动
    - 因Oracle官方已经抛弃cx_Oracle改为使用oracledb，访问ORACLE使用了oracledb包。该包可以直接使用thin模式的thin串。如果访问的数据库是RAC结构，需要使用service访问或需要兼容12.1.0.1版本以前的数据库，可以自行安装instanceClient并改用thick模式进行访问。此处因为需要适配公司老旧的11.2.0.4版本，已经改为thick模式
      - 注意，如果你电脑装安装过Oracle任何client，无论是完整dba client还是instance client，只要同时配置过环境变量，thick模式会优先取环境变量中的配置。但若没有配置过环境变量，需要自己指定lib_dir路径

2. 编辑db.ini文件，根据自己的实际情况配置数据库信息和生成文件的路径、文件名等信息

    - 此处需要注意，配置的数据库用户最低限度权限需要能够获取当前user/schema等概念下的表结构和对象信息，如果没有这个权限，该软件无法获取构造文档的数据，需要使用更高级别的权限请向研发或DBA索取，当然也可以让他们直接使用这个工具来生成文档
    - oracle不要使用sys用户进行，否则你会获取到乱七八糟的系统表而无法取到自己需要的表信息
    - 如果没有配置过Oracle环境变量且需要用thick模式访问，需要配置orcl_binpath，请注意
    - output部配置完成后的输出路径需要定义的文件名
    - log部配置日志存放的路径和文件切分格式。此处样例是按照时间进行分割，应对的是一个schema或user下有巨量的表信息需要提取，会产生很长的工作时间。但根据测试，对oracle的表数据，1000张表全部提取耗时3~5分钟，主要是在与数据库交互的查询报文和系统打印日志会比较耗时

3. 执行app.py，如一切配置正确，将在你定义的路径下找到以定义文件名命名的表结构excel文件
4. 拿着你的文档去干活吧！XD

## 进度
- 2023/12/6 创建这个项目
- 2023/12/8 实现了MSSQL数据的获取
- 2023/12/9-10 老子在睡觉
- 2023/12/11 实现了ORACLE数据的获取
- 2023/12/13 修改了bug，完善了一些表信息和格式

## 当前问题
1. 比较丑，哈哈
2. 因为我不熟MSSQL，所以MSSQL的约束和索引不知道怎么写查询SQL，留给后人了
3. 有些拆包封包的循环可能比较冗余，有兴趣的同学可以优化下
4. 发现一个很奇怪的问题，如果在调用数据库模块的函数前面使用loguru的捕获装饰器@logger.catch会造成在外层无法捕获到正确的exception……暂时只在python-oracledb这个包的调用时发现这个问题，不知道pyodbc或者pymysql会不会有一样的情况，抽空要试一下